# 聊天记录去重功能说明

## 概述

本扩展已实现了一个强大的聊天记录去重机制，参考了mobile-main的最佳实践，有效防止重复录入相同的聊天记录。

## 功能特点

### 多层去重机制

1. **基础哈希检查**：使用内容哈希快速识别完全相同的内容
2. **时间窗口检查**：防止短时间内重复处理相同内容
3. **内容相似性检查**：通过特征分析识别微小变化的重复内容
4. **智能批处理**：优化性能，避免频繁处理

### 性能优化

1. **内容哈希缓存**：缓存已处理内容的哈希值，提高比较效率
2. **批处理队列**：将多个请求合并处理，减少资源消耗
3. **智能缓存管理**：自动清理过期缓存，防止内存泄漏
4. **处理锁机制**：防止并发处理导致的数据不一致

## 使用方法

### 自动去重

去重功能会自动工作，无需手动干预。当检测到新的聊天记录时，系统会：

1. 计算内容哈希
2. 与已处理记录进行比较
3. 应用多层去重检查
4. 只处理真正的新记录

### 调试和监控

#### 启用调试模式

```javascript
// 在浏览器控制台中执行
window.chatRecordManager.setDebugMode(true);
```

启用调试模式后，可以使用以下调试函数：

```javascript
// 获取统计信息
window.chatRecordManagerDebug.getStats()

// 测试去重功能
window.chatRecordManagerDebug.testDeduplication(content)

// 清理缓存
window.chatRecordManagerDebug.clearCache(options)

// 强制处理内容
window.chatRecordManagerDebug.forceProcess(content)
```

#### 查看统计信息

```javascript
// 获取去重统计
const stats = window.chatRecordManager.getDeduplicationStats();
console.log(stats);
```

统计信息包含：
- `processedMessagesCount`: 已处理消息数量
- `contentHashCacheSize`: 内容哈希缓存大小
- `batchProcessingQueueLength`: 批处理队列长度
- `isBatchProcessing`: 是否正在批处理
- `isProcessing`: 是否正在处理
- `processingLock`: 处理锁状态
- `lastProcessTime`: 上次处理时间
- `timeSinceLastProcess`: 距离上次处理的时间

#### 手动清理缓存

```javascript
// 清理特定类型的缓存
window.chatRecordManager.clearCache({
    clearProcessedMessages: true,  // 清理处理消息缓存
    clearContentHashCache: true,  // 清理内容哈希缓存
    clearBatchQueue: true,        // 清理批处理队列
    clearAll: true               // 清理所有缓存
});
```

## 测试

### 使用测试页面

打开 `test-deduplication.html` 页面可以测试去重功能：

1. 在浏览器中打开测试页面
2. 输入聊天记录内容
3. 点击"测试去重"按钮
4. 查看测试结果和统计信息

### 测试用例

1. **完全相同的内容**：应该被识别为重复
2. **微小变化的内容**：应该被相似性检查识别
3. **时间窗口内的重复**：应该被时间窗口检查识别
4. **完全不同的内容**：应该被正常处理

## 技术实现

### 内容特征提取

系统会提取以下特征用于相似性比较：

- 好友名称模式
- 消息类型（文字、表情包、图片等）
- 时间戳模式
- 消息数量
- 内容长度
- 内容哈希

### 相似度计算

使用加权算法计算内容相似度：

- 好友名称相似度（权重：40%）
- 消息类型相似度（权重：20%）
- 消息数量相似度（权重：20%）
- 内容长度相似度（权重：10%）
- 哈希比较（权重：10%）

当相似度超过80%时，认为内容重复。

### 缓存策略

1. **处理消息缓存**：最多保留500条，智能保留重要条目
2. **内容哈希缓存**：最多保留1000个，保留最近使用的500个
3. **批处理队列**：临时存储待处理的记录

## 故障排除

### 常见问题

1. **仍然出现重复记录**
   - 检查是否启用了调试模式
   - 查看控制台是否有错误信息
   - 尝试清理所有缓存

2. **性能问题**
   - 检查缓存大小是否过大
   - 考虑调整批处理延迟
   - 查看是否有内存泄漏

3. **去重过于严格**
   - 调整相似度阈值（修改代码中的0.8值）
   - 检查特征提取是否准确
   - 考虑禁用某些检查

### 调试步骤

1. 打开浏览器开发者工具
2. 启用调试模式
3. 查看控制台日志
4. 使用测试页面验证功能
5. 检查统计信息是否正常

## 更新日志

### v1.0.0
- 实现基础去重机制
- 添加内容哈希缓存
- 实现时间窗口检查
- 添加调试功能

### v1.1.0
- 实现内容相似性检查
- 添加智能批处理
- 优化缓存管理
- 添加测试页面

## 贡献

如果您发现问题或有改进建议，请：

1. 查看现有的问题报告
2. 提供详细的复现步骤
3. 包含相关的日志信息
4. 建议具体的改进方案

## 许可证

本功能遵循项目的整体许可证。